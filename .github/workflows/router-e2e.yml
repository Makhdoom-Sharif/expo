name: Router Maestro E2E

on:
  pull_request:
    paths:
      - packages/@expo/cli/**
      - packages/expo-router/**

jobs:
  router-maestro:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Restore caches
        uses: ./.github/actions/expo-caches
        id: expo-caches
        with:
          yarn-workspace: 'true'

      - name: Install dependencies
        run: YARN_IGNORE_SCRIPTS=true yarn --frozen-lockfile

      - uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install Maestro
        run: |
          export MAESTRO_VERSION=1.36.0
          curl -Ls "https://get.maestro.mobile.dev" | bash
          arch -arm64 brew tap facebook/fb
          arch -arm64 brew install facebook/fb/idb-companion
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Build Expo CLI
        run: yarn workspace @expo/cli prepare

      - name: Start Expo CLI
        working-directory: apps/router-e2e
        env:
          E2E_ROUTER_USE_PUBLISHED_EXPO_GO: true
        run: |
          E2E_ROUTER_EXPO_PORT=8081
          E2E_ROUTER_EXPO_SERVER="http://localhost:${E2E_ROUTER_EXPO_PORT}"
          E2E_ROUTER_APP_URL="exp://localhost:${E2E_ROUTER_EXPO_PORT}"

          # Run the Expo Dev Server in the background
          node ../../packages/@expo/cli/build/bin/cli start --ios --port $E2E_ROUTER_EXPO_PORT &
          sleep 10

          # Start the build early
          BUNDLE_INFO=$(curl -H "Content-Type: multipart/mixed" -H "expo-platform: ios" $E2E_ROUTER_EXPO_SERVER)
          BUNDLE_URL=$(echo $BUNDLE_INFO | jq -r ".launchAsset.url")

          # Start the build early
          curl $BUNDLE_URL

          # Save the app url
          echo "MAESTRO_APP_URL=${E2E_ROUTER_APP_URL}" >> $GITHUB_ENV

      - name: Run Maestro iOS tests
        working-directory: apps/router-e2e
        env:
          MAESTRO_DRIVER_STARTUP_TIMEOUT: 180000
        run: |
          # Run the Expo Dev Server in the background
          maestro test launch-tests.yml --no-ansi --format=junit
